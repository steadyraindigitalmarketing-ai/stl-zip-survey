<!DOCTYPE html>
<html>
<head>
    <title>STL Zip Painter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 90vh; width: 100%; background: #eee; }
        .controls { height: 10vh; display: flex; align-items: center; gap: 10px; padding: 0 20px; background: #222; color: white; }
        .rating-btn { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .active { outline: 3px solid #fff; transform: scale(1.1); }
        #status { margin-left: auto; color: #aaa; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="controls">
        <span><b>Mode:</b></span>
        <button class="rating-btn" onclick="setRating(10, this)" style="background:#2ecc71;">10</button>
        <button class="rating-btn" onclick="setRating(5, this)" style="background:#f1c40f;">5</button>
        <button class="rating-btn" onclick="setRating(1, this)" style="background:#e74c3c;">1</button>
        <button onclick="exportData()" style="padding: 8px; cursor:pointer;">Download CSV</button>
        <div id="status">Loading St. Louis Boundaries...</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([38.627, -90.199], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let activeRating = null;
        let ratings = {};

        function setRating(val, btn) {
            activeRating = val;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Using a reliable Census-sourced GeoJSON for Missouri/Illinois area
        // Note: This file is large, give it a few seconds to load.
        const geoJsonUrl = 'https://raw.githubusercontent.com/OpenDataDE/State-zip-code-GeoJSON/master/mo_missouri_zip_codes_geo.min.json';

        fetch(geoJsonUrl)
            .then(res => res.json())
            .then(data => {
                document.getElementById('status').innerText = "Ready to Paint";
                L.geoJson(data, {
                    style: function(feature) {
                        return { color: "#444", weight: 1, fillOpacity: 0.1, fillColor: "#fff" };
                    },
                    onEachFeature: function(feature, layer) {
                        // Zip keys vary by file. Most use 'ZCTA5CE10' or 'zip'
                        const zipCode = feature.properties.ZCTA5CE10 || feature.properties.zip || feature.properties.ZCTA5;
                        
                        layer.on('click', function() {
                            if (!activeRating) return alert("Pick a number (1, 5, or 10) first!");
                            
                            const color = activeRating === 10 ? "#2ecc71" : (activeRating === 5 ? "#f1c40f" : "#e74c3c");
                            layer.setStyle({ fillColor: color, fillOpacity: 0.7 });
                            ratings[zipCode] = activeRating;
                        });

                        layer.bindTooltip("Zip: " + zipCode);
                    }
                }).addTo(map);
            })
            .catch(err => {
                document.getElementById('status').innerText = "Error loading map data.";
                console.error(err);
            });

        function exportData() {
            if (Object.keys(ratings).length === 0) return alert("No ratings to export!");
            let csv = "ZipCode,Rating\n";
            for (let zip in ratings) { csv += `${zip},${ratings[zip]}\n`; }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stl_sales_survey.csv';
            a.click();
        }
    </script>
</body>
</html>
