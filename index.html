<!DOCTYPE html>
<html>
<head>
    <title>St. Louis Lead Quality Survey</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100%; cursor: crosshair; }
        .controls { height: 10vh; display: flex; align-items: center; gap: 10px; padding: 0 20px; background: #f8f9fa; border-bottom: 2px solid #ddd; }
        .rating-btn { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; }
        .active { outline: 3px solid #007bff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="controls">
        <strong>Pick Rating to Paint:</strong>
        <button class="rating-btn" onclick="setRating(10, this)" style="background:#28a745; color:white;">10 (Best)</button>
        <button class="rating-btn" onclick="setRating(5, this)" style="background:#ffc107;">5 (Average)</button>
        <button class="rating-btn" onclick="setRating(1, this)" style="background:#dc3545; color:white;">1 (Poor)</button>
        <button onclick="exportData()" style="margin-left:auto;">Download Results (CSV)</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([38.627, -90.199], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let activeRating = null;
        let ratings = {}; 

        function setRating(val, btn) {
            activeRating = val;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // FETCH ZIP CODE DATA (St. Louis Regional Data Alliance)
        fetch('https://rdx.stldata.org/dataset/zip-code-zones/resource/geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJson(data, {
                    style: { color: "#333", weight: 1, fillOpacity: 0.1 },
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function() {
                            if (!activeRating) return alert("Select a rating first!");
                            
                            // Paint the Zip
                            const color = activeRating === 10 ? "#28a745" : (activeRating === 5 ? "#ffc107" : "#dc3545");
                            layer.setStyle({ fillColor: color, fillOpacity: 0.6 });
                            
                            // Save the Data
                            ratings[feature.properties.zip] = activeRating;
                        });
                        layer.bindTooltip("Zip: " + feature.properties.zip);
                    }
                }).addTo(map);
            });

        function exportData() {
            let csv = "ZipCode,Rating\n";
            for (let zip in ratings) { csv += `${zip},${ratings[zip]}\n`; }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'stl_lead_quality.csv');
            a.click();
        }
    </script>
</body>
</html>
